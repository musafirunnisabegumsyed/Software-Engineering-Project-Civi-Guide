<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emergency Services Along Route</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#121212; color:white; height:100vh; display:flex; flex-direction:column; }
  #map { flex:1; }
  .controls { padding:10px; background:#1a1a1a; color:white; display:flex; gap:10px; flex-wrap:wrap; position:relative; z-index:1000; }
  input, button, select { padding:6px; border-radius:5px; border:1px solid #555; background:#2a2a2a; color:white; }

  /* Sidebar */
  .sidebar {
      height: 100%;
      width: 0;
      position: fixed;
      top: 0; left: 0;
      background:#222;
      overflow-x: hidden;
      transition:0.3s;
      padding-top:60px;
      z-index:2000;
      color:white;
  }
  .sidebar h2 { padding-left:15px; font-size:18px; }
  .sidebar a { padding:10px 15px; display:block; text-decoration:none; font-size:16px; color:white; }
  .sidebar a:hover { background:#444; }

  /* Hamburger */
  .hamburger {
      position: fixed;
      top:15px; left:15px;
      z-index:3000;
      cursor:pointer;
      font-size:26px;
      color:white;
      background:#333;
      padding:8px 12px;
      border-radius:6px;
      user-select:none;
  }

  #distanceBox {
      position: absolute; top:60px; right:20px;
      background: rgba(0,0,0,0.7); color:white;
      padding:8px 12px; border-radius:8px; z-index:1000;
  }

  /* Leaflet routing text black */
  .leaflet-routing-container, .leaflet-routing-container * {
      color:black !important;
      font-weight:500;
  }
</style>
</head>
<body>

<!-- Hamburger -->
<div class="hamburger" onclick="toggleSidebar()">&#9776;</div>

<!-- Sidebar -->
<div id="mySidebar" class="sidebar">
   <a href ="sample.html">Home</a>
    <a href="live.html">Disaster zone detection </a>
     <a href="NATIONAL.HTML">National border alert </a>
    <a href="ambulance.html">Emergency services locator </a>
</div>

<!-- Controls -->
<div class="controls">
    <input id="source" placeholder="Source Location">
    <input id="destination" placeholder="Destination Location">
    <input id="via" placeholder="Optional Via (Intermediate)">
    <select id="serviceType">
        <option value="all">All Services</option>
        <option value="police">Police</option>
        <option value="hospital">Hospital</option>
        <option value="fire_station">Fire Station</option>
        <option value="pharmacy">Pharmacy</option>
        <option value="ambulance">Ambulance</option>
        <option value="shelter">Disaster Shelter</option>
        <option value="rescue">Rescue Station</option>
    </select>
    <button onclick="showRouteServices()">Show Services</button>
    <button id="micButton">&#127908;</button>
</div>

<!-- Map -->
<div id="map"></div>
<div id="distanceBox">Distance: 0 km | ETA: 0 min</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.min.js"></script>

<script>
const map = L.map('map').setView([20.5937,78.9629],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let routingControl = null;
let serviceMarkers = [];
let userMarker = null;
let arrowLayer = null;
let routeInstructions = [];
let currentStepIndex = 0;

const serviceTypes = ["police","hospital","fire_station","pharmacy","ambulance","shelter","rescue"];
const serviceIcons = {
  police: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/police-badge.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]}),
  hospital: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/hospital-room.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]}),
  fire_station: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/fire-station.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]}),
  pharmacy: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/pill.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]}),
  ambulance: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/ambulance.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]}),
  shelter: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/home.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]}),
  rescue: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/lifebuoy.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]}),
  user: L.icon({iconUrl:'https://img.icons8.com/color/48/000000/marker.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]})
};

// Sidebar toggle
function toggleSidebar(){
  const sidebar = document.getElementById("mySidebar");
  sidebar.style.width = sidebar.style.width==="250px" ? "0" : "250px";
}

// Clear previous markers and route
function clearMarkers(){
  serviceMarkers.forEach(m=>map.removeLayer(m));
  serviceMarkers=[];
  if(routingControl) { map.removeControl(routingControl); routingControl=null; }
  if(userMarker){ map.removeLayer(userMarker); userMarker=null; }
  if(arrowLayer){ map.removeLayer(arrowLayer); arrowLayer=null; }
}

// Fallback contact
function getFallbackContact(type){
  switch(type){
    case "police": return "100 / 112";
    case "hospital": return "102 / 108";
    case "fire_station": return "101";
    case "ambulance": return "108";
    case "shelter": return "N/A";
    case "rescue": return "N/A";
    case "pharmacy": return "N/A";
    default: return "N/A";
  }
}

// Get coordinates from location name
async function getCoords(location){
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
  const data = await res.json();
  if(data.length===0) throw new Error("Location not found: "+location);
  return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
}

// Fetch nearby services
async function fetchServices(lat, lon, type){
  let query='';
  if(type==='all'){
    query = `[out:json][timeout:25];
      (node(around:2000,${lat},${lon})[amenity~"police|hospital|fire_station|pharmacy|ambulance|shelter|rescue"];
       way(around:2000,${lat},${lon})[amenity~"police|hospital|fire_station|pharmacy|ambulance|shelter|rescue"];
      );
      out center tags;`;
  } else {
    query = `[out:json][timeout:25];
      (node(around:2000,${lat},${lon})[amenity=${type}];
       way(around:2000,${lat},${lon})[amenity=${type}];
      );
      out center tags;`;
  }
  try{
    const res = await fetch("https://overpass-api.de/api/interpreter",{method:'POST', headers:{'Content-Type':'text/plain'}, body:query});
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); } catch(e){ return []; }
    return data.elements.map(el=>{
      if(el.type==='node') return {lat:el.lat, lon:el.lon, tags:el.tags||{}};
      if(el.type==='way' && el.center) return {lat:el.center.lat, lon:el.center.lon, tags:el.tags||{}};
      return null;
    }).filter(el=>el!==null);
  }catch(err){ return []; }
}

// Add marker
function addMarker(lat, lon, name, contact, type){
  const icon = serviceIcons[type]||serviceIcons['police'];
  const m = L.marker([lat, lon], {icon}).addTo(map).bindPopup(`${name} - ${contact}`);
  serviceMarkers.push(m);
}

// Sample points along route
function sampleRouteCoordinates(routeCoordinates, step=5){
  const sampled=[];
  for(let i=0;i<routeCoordinates.length;i+=step) sampled.push(routeCoordinates[i]);
  return sampled;
}

// Show route and services
async function showRouteServices(){
  clearMarkers();
  const source = document.getElementById('source').value.trim();
  const destination = document.getElementById('destination').value.trim();
  const via = document.getElementById('via').value.trim();
  const serviceType = document.getElementById('serviceType').value;
  if(!source||!destination){ alert("Enter both source and destination"); return; }

  try{
    const srcCoords = await getCoords(source);
    const destCoords = await getCoords(destination);
    let waypoints = [L.latLng(srcCoords[0], srcCoords[1])];
    if(via){
      const viaCoords = await getCoords(via);
      waypoints.push(L.latLng(viaCoords[0], viaCoords[1]));
    }
    waypoints.push(L.latLng(destCoords[0], destCoords[1]));

    routingControl = L.Routing.control({
      waypoints: waypoints,
      lineOptions:{styles:[{color:'red',weight:5}]},
      router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
      show:false,
      addWaypoints:false,
      routeWhileDragging:false
    }).addTo(map);

    routingControl.on('routesfound', async function(e){
      const route = e.routes[0];
      const distanceKm = (route.summary.totalDistance/1000).toFixed(2);
      const durationMin = Math.round(route.summary.totalTime/60);
      document.getElementById('distanceBox').innerText = `Distance: ${distanceKm} km | ETA: ${durationMin} min`;

      const routeCoords = route.coordinates.map(pt=>({lat:pt.lat||pt[1], lng:pt.lng||pt[0]}));

      // Draw arrows
      arrowLayer = L.polylineDecorator(L.polyline(routeCoords.map(p=>[p.lat,p.lng])),{
        patterns:[{offset:25, repeat:50, symbol:L.Symbol.arrowHead({pixelSize:8, polygon:false, pathOptions:{color:'red',weight:2}})}]
      }).addTo(map);

      const sampledPoints = sampleRouteCoordinates(routeCoords, 10);
      for(const pt of sampledPoints){
        const typesToFetch = serviceType==='all'?serviceTypes:[serviceType];
        for(const type of typesToFetch){
          const services = await fetchServices(pt.lat, pt.lng, type);
          services.forEach(s=>{
            const name = s.tags.name||type.charAt(0).toUpperCase()+type.slice(1);
            const contact = s.tags.phone||getFallbackContact(type);
            addMarker(s.lat,s.lon,name,contact,type);
          });
        }
      }
    });

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        userMarker=L.marker([lat,lon],{icon:serviceIcons.user}).addTo(map).bindPopup("You are here").openPopup();
        map.setView([lat,lon],13);
      });
    }
  }catch(err){ alert(err.message); }
}

// Voice directions
function speak(text){
  let utter = new SpeechSynthesisUtterance(text);
  utter.lang='en-US';
  window.speechSynthesis.speak(utter);
}

document.getElementById('micButton').onclick = function(){
  if(!routingControl){ alert("No route loaded."); return; }
  currentStepIndex = 0;
  speak("Starting navigation. Follow the instructions.");

  let steps = routingControl.getRoutes()[0].instructions || [];
  let interval = setInterval(()=>{
    if(currentStepIndex<steps.length){
      speak(steps[currentStepIndex].text);
      currentStepIndex++;
    } else {
      speak("You have arrived at your destination.");
      clearInterval(interval);
    }
  },8000);
};

</script>
</body>
</html>
